const fs = require('fs');
const path = require('path');

// Read the ZocDoc reviews JSON
const reviewsPath = path.join(__dirname, '..', 'data', 'reviews', 'zocdoc-reviews-all.json');
const zocdocReviews = JSON.parse(fs.readFileSync(reviewsPath, 'utf-8'));

// Calculate statistics from ALL reviews (not just filtered ones)
const totalReviews = zocdocReviews.length;
const sumRatings = zocdocReviews.reduce((sum, r) => sum + r.rating, 0);
const averageRating = (sumRatings / totalReviews).toFixed(2);

// Calculate rating distribution
const ratingDistribution = {
  fiveStars: zocdocReviews.filter(r => r.rating === 5).length,
  fourStars: zocdocReviews.filter(r => r.rating === 4).length,
  threeStars: zocdocReviews.filter(r => r.rating === 3).length,
  twoStars: zocdocReviews.filter(r => r.rating === 2).length,
  oneStar: zocdocReviews.filter(r => r.rating === 1).length,
};

// Filter for reviews with text and 5-star rating (for display)
const reviewsWithText = zocdocReviews.filter(r => r.review && r.review.trim() !== '' && r.rating === 5);

console.log(`Found ${reviewsWithText.length} reviews with text and 5-star ratings`);
console.log(`Total reviews: ${totalReviews}, Average rating: ${averageRating}\n`);

// Helper function to extract initials from name
function getInitials(name) {
  if (!name) return 'AP'; // Anonymous Patient

  // Handle cases like "Initials hidden"
  if (name.toLowerCase().includes('initials hidden') || name.toLowerCase().includes('anonymous')) {
    return 'AP';
  }

  // Handle formats like "Alison V." or "FERNANDO S."
  const parts = name.trim().split(/\s+/);

  if (parts.length === 1) {
    // Single part like "AL" or "OA" - use as-is if 2-3 chars, otherwise take first 2
    return parts[0].length <= 3 ? parts[0].toUpperCase() : parts[0].substring(0, 2).toUpperCase();
  }

  // Multiple parts like "Alison V." or "Victoria M."
  const firstInitial = parts[0][0].toUpperCase();
  const lastInitial = parts[parts.length - 1][0].toUpperCase();

  return firstInitial + lastInitial;
}

// Transform to website format
const websiteReviews = reviewsWithText.map((review, index) => ({
  id: index + 1,
  name: review.name || 'Anonymous Patient',
  rating: review.rating,
  date: review.date || 'Recently',
  review: review.review,
  initials: getInitials(review.name),
  location: 'Eye & Health',
  // Note: service field is optional and omitted
}));

// Generate TypeScript array string
let output = 'const reviews = [\n';

websiteReviews.forEach((review, index) => {
  output += '  {\n';
  output += `    id: ${review.id},\n`;
  output += `    name: "${review.name}",\n`;
  output += `    rating: ${review.rating},\n`;
  output += `    date: "${review.date}",\n`;
  output += `    review: "${review.review.replace(/"/g, '\\"').replace(/\n/g, ' ')}",\n`;
  output += `    initials: "${review.initials}",\n`;
  output += `    location: "${review.location}"\n`;
  output += `  }${index < websiteReviews.length - 1 ? ',' : ''}\n`;
});

output += '] as Review[];\n';

// Output to console
console.log('='.repeat(80));
console.log('TYPESCRIPT REVIEWS ARRAY - Copy and paste into data/index.tsx');
console.log('='.repeat(80));
console.log('\n');
console.log(output);
console.log('\n');
console.log('='.repeat(80));
console.log(`Total reviews: ${websiteReviews.length}`);
console.log(`Average rating: ${(websiteReviews.reduce((sum, r) => sum + r.rating, 0) / websiteReviews.length).toFixed(2)}`);
console.log('='.repeat(80));

// Also save to a file for reference
const outputPath = path.join(__dirname, '..', 'data', 'reviews', 'website-reviews.ts');
fs.writeFileSync(outputPath, output);
console.log(`\nAlso saved to: ${outputPath}`);

// Generate the centralized review stats file
const today = new Date().toISOString().split('T')[0];
const statsContent = `/**
 * Centralized review statistics
 *
 * This file is auto-generated by scripts/convert-zocdoc-to-website-format.js
 * DO NOT EDIT MANUALLY - run the conversion script to update these values
 *
 * Usage:
 *   import { REVIEW_STATS } from '@/lib/review-stats';
 *   console.log(REVIEW_STATS.averageRating); // "${averageRating}"
 *   console.log(REVIEW_STATS.totalReviews);  // ${totalReviews}
 */

export const REVIEW_STATS = {
  /** Average rating from all ZocDoc reviews (e.g., "${averageRating}") */
  averageRating: "${averageRating}",

  /** Average rating as a number for calculations */
  ratingValue: ${averageRating},

  /** Total number of reviews on ZocDoc */
  totalReviews: ${totalReviews},

  /** Number of reviews with written text (displayable) */
  reviewsWithText: ${reviewsWithText.length},

  /** Rating distribution */
  ratingDistribution: {
    fiveStars: ${ratingDistribution.fiveStars},
    fourStars: ${ratingDistribution.fourStars},
    threeStars: ${ratingDistribution.threeStars},
    twoStars: ${ratingDistribution.twoStars},
    oneStar: ${ratingDistribution.oneStar},
  },

  /** Last updated timestamp */
  lastUpdated: "${today}",

  /** Source of the reviews */
  source: "ZocDoc" as const,
} as const;

/** Type for the review stats object */
export type ReviewStats = typeof REVIEW_STATS;
`;

const statsOutputPath = path.join(__dirname, '..', 'lib', 'review-stats.ts');
fs.writeFileSync(statsOutputPath, statsContent);
console.log(`Review stats saved to: ${statsOutputPath}`);
